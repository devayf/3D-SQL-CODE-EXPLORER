<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TTX — 3D SQL Environment Explorer</title>
  <style>
  :root{
    --bg:#0b0f14; --panel:#0e141c; --accent:#f2c200; --muted:#9aa4af; --border:#223; --text:#e6e6e6;
    --sidebar-w:560px;
  }

  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;overflow:hidden}

  #topbar{position:fixed;top:0;left:0;right:0;background:linear-gradient(90deg,#121821,#121821 70%,#1a2130);padding:10px;display:flex;gap:8px;align-items:center;z-index:10;border-bottom:1px solid var(--border)}
  .brand{display:flex;align-items:center;gap:10px;padding-right:12px;border-right:1px solid var(--border)}
  .title{font-weight:700;letter-spacing:.3px}
  #topbar input,#topbar button,#topbar select{background:var(--bg);color:var(--text);border:1px solid var(--border);padding:6px 8px;border-radius:6px}

  /* cleaner inputs */
  input[type="number"]::-webkit-outer-spin-button,
  input[type="number"]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0 }
  input[type="number"]{ -moz-appearance:textfield }
  #search{
    padding-right:28px;
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" fill="%239aa4af" viewBox="0 0 24 24"><path d="M9.5 3a6.5 6.5 0 015.2 10.5l4.15 4.15-1.4 1.4-4.15-4.15A6.5 6.5 0 119.5 3zm0 2a4.5 4.5 0 100 9 4.5 4.5 0 000-9z"/></svg>');
    background-repeat:no-repeat; background-position:right 8px center;
  }

  /* custom suggestions dropdown */
  .searchwrap{ position:relative; width:340px; }
  .sugg{
    position:absolute; left:0; right:0; top:calc(100% + 4px);
    background:var(--panel); border:1px solid var(--border); border-radius:8px;
    max-height:260px; overflow:auto; box-shadow:0 10px 30px rgba(0,0,0,.35); z-index:12;
  }
  .sugg.hidden{ display:none }
  .sugg .item{ padding:8px 10px; font-size:14px; cursor:pointer; display:flex; justify-content:space-between; gap:8px }
  .sugg .item:hover{ background:#0b0f14 }
  .sugg .type{ color:var(--muted); font-size:12px }

  /* canvas + collapsible sidebar */
  #canvas{position:absolute;top:52px;bottom:0;left:0;right:var(--sidebar-w);transition:right .25s ease}

  #sidebar{
    position:fixed;top:52px;right:0;bottom:0;width:var(--sidebar-w);
    background:var(--panel);border-left:1px solid var(--border);
    display:grid;grid-template-rows:1fr auto;
    transform:translateX(0);transition:transform .25s ease;
  }
  body.sidebar-collapsed #sidebar{transform:translateX(var(--sidebar-w))}
  body.sidebar-collapsed #canvas{right:0}

  #toggleHandle{
    position:fixed;top:50%;right:var(--sidebar-w);transform:translateY(-50%);
    background:var(--panel);color:var(--text);border:1px solid var(--border);border-right:none;
    padding:6px 8px;border-radius:8px 0 0 8px;cursor:pointer;z-index:11;line-height:1
  }
  body.sidebar-collapsed #toggleHandle{right:0;border-right:1px solid var(--border);border-left:none;border-radius:0 8px 8px 0}

  #inspector{padding:12px;border-bottom:1px solid var(--border);overflow:auto;min-height:0}
  #details{color:var(--muted);font-size:13px}
  #details pre{overflow-wrap:anywhere;white-space:pre-wrap}

  #chat{display:grid;grid-template-rows:1fr auto;height:100%}
  #chatlog{padding:12px;overflow:auto}
  .chat-msg{margin-bottom:10px}
  .chat-role{font-size:12px;color:var(--muted)}
  .chat-bubble{background:#0b0f14;border:1px solid var(--border);padding:8px;border-radius:8px;margin-top:4px;white-space:pre-wrap}
  #chatctl{padding:10px;border-top:1px solid var(--border);display:grid;grid-template-columns:1fr auto;gap:8px}
  #prompt{background:#0b0f14;color:var(--text);border:1px solid var(--border);border-radius:8px;padding:8px;min-height:56px}
  #send{background:var(--accent);color:#111;border:0;padding:10px 14px;border-radius:8px;font-weight:700}
  .muted{color:var(--muted)}
  .pill{display:inline-block;padding:2px 6px;border-radius:999px;border:1px solid var(--border);font-size:12px;margin-right:6px}
  .legend .pill{margin-top:4px}


  </style>
</head>
<body>
  <div id="topbar">
    <div class="brand">
      <img src="TTX_Company-Logo.wine.png" alt="TTX Logo" style="height:72px;width:auto;object-fit:contain;vertical-align:middle;">
      <span class="title">3D SQL Environment Explorer</span>
    </div>

    <!-- Search with custom dropdown -->
    <div class="searchwrap">
      <input id="search" type="text" placeholder="Search node by name..." autocomplete="on" />
      <div id="sugg" class="sugg hidden"></div>
    </div>

    <label>Radius <input id="radius" type="number" min="0" max="25" value="4" style="width:64px"></label>
    <input id="file" type="file" accept=".json,application/json" />
    <button id="btnDemo">Load Demo</button>
    <span class="muted">HDSTTX</span>
  </div>

  <div id="canvas"></div>

  <div id="sidebar">
    <div id="inspector">
      <div class="legend">
        <span class="pill">Size = degree</span>
        <span class="pill">Color = type</span>
        <span class="pill">Links = deps</span>
      </div>
      <h3 id="title" style="margin:10px 0 6px 0;">Details</h3>
      <div id="details" class="muted">Load a JSON model or the demo. Select a node to view SQL.</div>
    </div>
    <div id="chat">
      <div id="chatlog"></div>
      <div id="chatctl">
        <textarea id="prompt" placeholder='Commands: help | focus <id> | neighbors <id> [r] | shortest <src> <dst> | search <text>'></textarea>
        <button id="send">Ask</button>
      </div>
    </div>
  </div>

  <button id="toggleHandle" aria-label="Toggle sidebar">◂</button>

  <script src="https://unpkg.com/three@0.157.0/build/three.min.js"></script>
  <script src="https://unpkg.com/3d-force-graph@1.73.3/dist/3d-force-graph.min.js"></script>

  <!-- Inline demo data -->
  <script type="application/json" id="ttx-demo">
  {
    "nodes":[
      {"id":"dbo.TMS_BOM","name":"dbo.TMS_BOM","type":"Table","sql":"SELECT * FROM dbo.TMS_BOM;"},
      {"id":"dbo.CarRequest","name":"dbo.CarRequest","type":"Table","sql":"SELECT * FROM dbo.CarRequest;"},
      {"id":"dbo.GetOpenReqs","name":"dbo.GetOpenReqs","type":"Proc","sql":"CREATE PROC dbo.GetOpenReqs AS SELECT * FROM dbo.CarRequest WHERE Status='Open';"},
      {"id":"vw_ActiveCars","name":"vw_ActiveCars","type":"View","sql":"CREATE VIEW vw_ActiveCars AS SELECT * FROM dbo.TMS_BOM WHERE Active=1;"}
    ],
    "links":[
      {"source":"dbo.GetOpenReqs","target":"dbo.CarRequest","kind":"DEPENDS_ON"},
      {"source":"vw_ActiveCars","target":"dbo.TMS_BOM","kind":"DEPENDS_ON"},
      {"source":"dbo.CarRequest","target":"dbo.TMS_BOM","kind":"JOINS"}
    ]
  }
  </script>

  <script>
    // ------- state -------
    let fullData = { nodes: [], links: [] };
    let currentRoot = null;
    let searchIndex = [];

    // ------- graph -------
    const g = ForceGraph3D()(document.getElementById('canvas'))
      .backgroundColor('#0b0f14')
      .nodeAutoColorBy('type')
      .nodeLabel(n => `${n.name || n.id}`)
      .nodeVal(n => 1 + (n.degree || 0))
      .linkColor(() => '#888')
      .linkOpacity(0.6)
      .enableNodeDrag(false)
      .showNavInfo(false)
      .onNodeClick(node => {
        currentRoot = node.id;
        showDetails(node);
        renderNeighborhood(node.id, getRadius()); // if radius=0, isolate
      });

    // --- smooth spheres override ---
    if (typeof g.nodeResolution === 'function') g.nodeResolution(24);
    const colorByType = t => ({Table:'#4aa3ff', View:'#9b59b6', Proc:'#f1c40f'}[t] || '#9aa4af');
    g.nodeThreeObject(n => {
      const s = 3 + (n.degree || 0);
      const geom = new THREE.SphereGeometry(s, 32, 32);
      const mat = new THREE.MeshStandardMaterial({ color: colorByType(n.type), roughness: 0.6, metalness: 0.1 });
      return new THREE.Mesh(geom, mat);
    });
    g.nodeThreeObjectExtend(false);

    const scene = g.scene();
    scene.add(new THREE.AmbientLight(0xffffff, 0.9));
    const dir = new THREE.DirectionalLight(0xffffff, 0.7);
    dir.position.set(80, 80, 80);
    scene.add(dir);

    // ------- sidebar toggle -------
    const handle = document.getElementById('toggleHandle');
    const collapseKey = 'sidebar-collapsed';
    const setHandleIcon = () => handle.textContent = document.body.classList.contains('sidebar-collapsed') ? '▸' : '◂';
    const fitGraph = () => { try { g.zoomToFit(600, 60); } catch(_) {} };
    if (localStorage.getItem(collapseKey) === '1') document.body.classList.add('sidebar-collapsed');
    setHandleIcon();
    setTimeout(() => { window.dispatchEvent(new Event('resize')); fitGraph(); }, 60);
    handle.addEventListener('click', () => {
      document.body.classList.toggle('sidebar-collapsed');
      localStorage.setItem(collapseKey, document.body.classList.contains('sidebar-collapsed') ? '1':'0');
      setHandleIcon();
      setTimeout(() => { window.dispatchEvent(new Event('resize')); fitGraph(); }, 260);
    });

    // ------- file loader -------
    document.getElementById('file').addEventListener('change', async (e) => {
      const file = e.target.files[0]; if (!file) return;
      try {
        const text = await file.text();
        const json = JSON.parse(text);
        loadGraph(json);
        afterLoad();
        logSys(`Model loaded: ${fullData.nodes.length} nodes, ${fullData.links.length} links.`);
      } catch (err) {
        console.error(err); logSys('Invalid JSON file.');
      }
    });

    // ------- demo loader -------
    function loadTTXDemo(){
      const tag = document.getElementById('ttx-demo');
      if (!tag){ logSys('Embedded demo not found.'); return; }
      const json = JSON.parse(tag.textContent);
      loadGraph(json);
      afterLoad();
      logSys(`TTX demo loaded: ${fullData.nodes.length} nodes, ${fullData.links.length} links.`);
    }
    document.getElementById('btnDemo').onclick = loadTTXDemo;

    // ------- search plumbing (custom dropdown + auto-focus) -------
    const searchEl = document.getElementById('search');
    const suggEl = document.getElementById('sugg');

    function applyFocusToNode(node){
      if (!node) return;
      currentRoot = node.id;
      showDetails(node);
      renderNeighborhood(node.id, getRadius()); // respects current radius; 0 isolates
      logSys(`Focused ${node.id}`);
    }

    function findBestMatch(q){
      const ql = q.toLowerCase();
      return fullData.nodes.find(n => String(n.id).toLowerCase() === ql || String(n.name||'').toLowerCase() === ql) ||
             fullData.nodes.find(n => String(n.name||'').toLowerCase().includes(ql)) ||
             fullData.nodes.find(n => String(n.id).toLowerCase().includes(ql));
    }

    function updateSuggestions(q){
      const ql = q.toLowerCase().trim();
      if (!ql){ suggEl.classList.add('hidden'); suggEl.innerHTML = ''; return; }
      const hits = searchIndex
        .filter(x => x.name.toLowerCase().includes(ql) || x.id.toLowerCase().includes(ql))
        .slice(0,12);

      if (!hits.length){ suggEl.classList.add('hidden'); suggEl.innerHTML = ''; return; }

      suggEl.innerHTML = hits.map(h => (
        `<div class="item" data-id="${h.id}">
           <span>${h.name}</span>
           <span class="type">${(h.label.split(' · ')[1]||'').trim()}</span>
         </div>`
      )).join('');
      suggEl.classList.remove('hidden');

      // click select
      Array.from(suggEl.querySelectorAll('.item')).forEach(el => {
        el.onclick = () => {
          const id = el.getAttribute('data-id');
          const node = fullData.nodes.find(n => String(n.id) === id);
          searchEl.value = node?.name || node?.id || '';
          suggEl.classList.add('hidden');
          applyFocusToNode(node);
        };
      });
    }

    // auto-apply on input when an exact match exists; always show suggestions
    searchEl.addEventListener('input', () => {
      const q = searchEl.value;
      updateSuggestions(q);
      const exact = findBestMatch(q);
      // only auto-apply if exact id/name match to avoid jumping on partial typing
      if (exact && (String(exact.id).toLowerCase() === q.toLowerCase() || String(exact.name||'').toLowerCase() === q.toLowerCase())){
        applyFocusToNode(exact);
        suggEl.classList.add('hidden');
      }
    });

    // hide suggestions on outside click
    document.addEventListener('click', (e) => {
      if (!suggEl.contains(e.target) && e.target !== searchEl) suggEl.classList.add('hidden');
    });

    // ------- chat commands -------
    document.getElementById('send').onclick = onAsk;
    function onAsk(){
      const p = document.getElementById('prompt').value.trim();
      if (!p) return;
      addChat('you', p);
      handleLocalQuery(p);
      document.getElementById('prompt').value = '';
    }
    function handleLocalQuery(q){
      const [cmd, ...rest] = q.split(/\s+/); const arg = rest.join(' ');
      switch ((cmd||'').toLowerCase()){
        case 'help':
          addChat('assistant',"Commands:\n- focus <nodeId>\n- neighbors <nodeId> [radius]\n- shortest <src> <dst>\n- search <text>\n- radius <n>\n- types <Table|View|Proc>");
          break;
        case 'focus': {
          const id = rest[0]; const node = fullData.nodes.find(n => n.id === id);
          if (!node){ addChat('assistant',`No node ${id}`); return; }
          applyFocusToNode(node);
        } break;
        case 'search': {
          const txt = arg.toLowerCase();
          const hits = fullData.nodes.filter(n => (n.name||n.id).toLowerCase().includes(txt)).slice(0,20);
          addChat('assistant', hits.length ? `Matches (${hits.length}): ${hits.map(h=>h.id).join(', ')}` : 'No matches');
        } break;
        case 'neighbors': {
          const id = rest[0]; const r = parseInt(rest[1]||String(getRadius()),10);
          if (!id){ addChat('assistant','Usage: neighbors <nodeId> [radius]'); return; }
          const node = fullData.nodes.find(n => n.id === id);
          if (!node){ addChat('assistant',`No node ${id}`); return; }
          renderNeighborhood(id, Number.isNaN(r)?getRadius():r);
          const adj = buildIndex(fullData);
          const nb = Array.from(adj.get(id)||[]);
          addChat('assistant', `Neighbors of ${id} (1 hop): ${nb.join(', ') || '(none)'}`);
        } break;
        case 'shortest': {
          const [src,dst] = rest;
          if (!src||!dst){ addChat('assistant','Usage: shortest <src> <dst>'); return; }
          const path = shortestPath(src,dst,fullData);
          if (!path){ addChat('assistant',`No path from ${src} to ${dst}`); return; }
          highlightPath(path); addChat('assistant',`Shortest path (${path.length-1} hops): ${path.join(' -> ')}`);
        } break;
        case 'radius': {
          const n = parseInt(rest[0]||'4',10);
          document.getElementById('radius').value = String(n);
          onRadiusChange();
          addChat('assistant',`Radius set to ${n}`);
        } break;
        case 'types': {
          const want = new Set(rest.join('').split('|').map(s=>s.trim()));
          const hits = fullData.nodes.filter(n => want.has((n.type||'').toString()));
          addChat('assistant', hits.length ? `Types ${Array.from(want).join('|')}: ${hits.slice(0,20).map(h=>h.id).join(', ')}${hits.length>20?' …':''}` : 'No matches');
        } break;
        default: addChat('assistant','Unknown command. Type "help".');
      }
    }

    // ------- helpers -------
    function getRadius(){
      const v = parseInt(document.getElementById('radius').value, 10);
      return Number.isNaN(v) ? 4 : v; // keeps 0; default 4
    }
    function computeDegree(data){
      const deg = new Map(); data.nodes.forEach(n => deg.set(n.id, 0));
      data.links.forEach(l => {
        const s = typeof l.source === 'object' ? l.source.id : l.source;
        const t = typeof l.target === 'object' ? l.target.id : l.target;
        deg.set(s, (deg.get(s)||0)+1); deg.set(t, (deg.get(t)||0)+1);
      });
      data.nodes.forEach(n => n.degree = deg.get(n.id) || 0);
    }
    function buildIndex(data){
      const adj = new Map();
      data.nodes.forEach(n => adj.set(n.id, new Set()));
      data.links.forEach(l => {
        const s = typeof l.source === 'object' ? l.source.id : l.source;
        const t = typeof l.target === 'object' ? l.target.id : l.target;
        adj.get(s)?.add(t); adj.get(t)?.add(s);
      });
      return adj;
    }
    function bfsSubgraph(startId, radius, data){
      if (!startId) return data;
      const adj = buildIndex(data);
      const vis = new Set([startId]);
      const q = [[startId,0]];
      while(q.length){
        const [u,d] = q.shift();
        if (d === radius) continue;
        for (const v of (adj.get(u)||[])){ if (!vis.has(v)){ vis.add(v); q.push([v,d+1]); } }
      }
      const nodes = data.nodes.filter(n => vis.has(n.id));
      const S = new Set(nodes.map(n => n.id));
      const links = data.links.filter(l => {
        const s = typeof l.source === 'object' ? l.source.id : l.source;
        const t = typeof l.target === 'object' ? l.target.id : l.target;
        return S.has(s) && S.has(t);
      });
      return { nodes, links };
    }
    function renderNeighborhood(rootId, radius){
      const sub = bfsSubgraph(rootId || (fullData.nodes[0]?.id), radius, fullData);
      computeDegree(sub);
      g.graphData({ nodes: [], links: [] }); // flush
      requestAnimationFrame(() => {
        g.graphData(sub);
        setTimeout(() => { try { g.zoomToFit(600, 60); } catch(_) {} }, 60);
      });
    }
    function shortestPath(src,dst,data){
      const adj = buildIndex(data);
      const q = [[src]]; const seen = new Set([src]);
      while(q.length){
        const path = q.shift(), last = path[path.length-1];
        if (last === dst) return path;
        for (const v of (adj.get(last)||[])){ if (!seen.has(v)){ seen.add(v); q.push(path.concat(v)); } }
      }
      return null;
    }
    function highlightPath(path){
      const set = new Set(path);
      const links = fullData.links.filter(l => {
        const s = typeof l.source === 'object' ? l.source.id : l.source;
        const t = typeof l.target === 'object' ? l.target.id : l.target;
        return set.has(s) && set.has(t);
      });
      const nodes = fullData.nodes.filter(n => set.has(n.id));
      g.graphData({nodes, links});
    }

    // ------- details pane -------
    function showDetails(n){
      const el = document.getElementById('details');
      const name = n.name || n.id;
      const type = n.type || 'Object';
      const deg  = n.degree ?? 0;
      const sql  = n.sql || 'No SQL available.';
      el.innerHTML = `
        <div><strong>${escapeHtml(name)}</strong></div>
        <div class="muted">${escapeHtml(type)} · degree ${deg}</div>
        <div style="margin-top:8px" class="muted">SQL</div>
        <pre style="white-space:pre-wrap;background:#0b0f14;border:1px solid var(--border);border-radius:6px;padding:8px;max-height:42vh;overflow:auto">${escapeHtml(sql)}</pre>
        <div style="margin-top:8px" class="muted">Properties</div>
        <pre style="white-space:pre-wrap;background:#0b0f14;border:1px solid var(--border);border-radius:6px;padding:8px;max-height:22vh;overflow:auto">${escapeHtml(JSON.stringify({id:n.id,type:n.type,degree:n.degree}, null, 2))}</pre>
      `;
      document.getElementById('title').textContent = name;
    }
    function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

    // ------- data plumbing -------
    function normalizeLinks(json){
      json.links = (json.links || []).map(l => ({
        source: typeof l.source === 'object' ? l.source.id : l.source,
        target: typeof l.target === 'object' ? l.target.id : l.target,
        kind: l.kind || 'DEPENDS_ON'
      }));
      return json;
    }
    function loadGraph(json){
      if (!json || !Array.isArray(json.nodes) || !Array.isArray(json.links)){
        logSys('Invalid model JSON structure.'); return;
      }
      fullData = normalizeLinks(json);
      computeDegree(fullData);
    }
    function afterLoad(){
      buildSearchIndex(fullData.nodes);
      populateDatalist(searchIndex); // not displayed, used for fast filtering
      const startId = fullData.nodes[0]?.id;
      if (startId) { currentRoot = startId; renderNeighborhood(startId, getRadius()); }
    }

    // ------- chat log -------
    function logSys(msg){
      const el = addChat('system', msg);
      setTimeout(() => el.remove(), 3000);
    }
    function addChat(role, content){
      const wrap = document.createElement('div');
      wrap.className = 'chat-msg';
      const r = document.createElement('div');
      r.className = 'chat-role';
      r.textContent = role;
      const b = document.createElement('div');
      b.className = 'chat-bubble';
      b.textContent = content;
      wrap.appendChild(r);
      wrap.appendChild(b);
      const log = document.getElementById('chatlog');
      log.appendChild(wrap);
      log.scrollTop = log.scrollHeight;
      return wrap;
    }

    // ------- radius change handler -------
    function onRadiusChange(){
      const root = currentRoot || fullData.nodes[0]?.id;
      if (!root) return;
      renderNeighborhood(root, getRadius());
    }
    document.getElementById('radius').addEventListener('input', onRadiusChange);
    document.getElementById('radius').addEventListener('change', onRadiusChange);

    // ------- search index helpers -------
    function buildSearchIndex(nodes){
      const seen = new Set();
      searchIndex = nodes.map(n => ({
        id: String(n.id),
        name: String(n.name || n.id),
        label: `${n.name || n.id}${n.type ? ' · ' + n.type : ''}`
      })).filter(x => { const k = x.name.toLowerCase(); if (seen.has(k)) return false; seen.add(k); return true; });
    }
    function populateDatalist(){ /* kept for parity; using custom dropdown */ }

    // ------- single init -------
    (function init(){
      document.getElementById('radius').value = 4; // startup radius
      g.graphData({ nodes: [], links: [] });
      loadTTXDemo();
    })();
  </script>
</body>
</html>
